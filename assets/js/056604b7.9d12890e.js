"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[25208],{3905:(e,t,o)=>{o.d(t,{Zo:()=>u,kt:()=>m});var a=o(67294);function n(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function r(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,a)}return o}function l(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?r(Object(o),!0).forEach((function(t){n(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):r(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function i(e,t){if(null==e)return{};var o,a,n=function(e,t){if(null==e)return{};var o,a,n={},r=Object.keys(e);for(a=0;a<r.length;a++)o=r[a],t.indexOf(o)>=0||(n[o]=e[o]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)o=r[a],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(n[o]=e[o])}return n}var s=a.createContext({}),p=function(e){var t=a.useContext(s),o=t;return e&&(o="function"==typeof e?e(t):l(l({},t),e)),o},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var o=e.components,n=e.mdxType,r=e.originalType,s=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),d=p(o),m=n,h=d["".concat(s,".").concat(m)]||d[m]||c[m]||r;return o?a.createElement(h,l(l({ref:t},u),{},{components:o})):a.createElement(h,l({ref:t},u))}));function m(e,t){var o=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=o.length,l=new Array(r);l[0]=d;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:n,l[1]=i;for(var p=2;p<r;p++)l[p]=o[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,o)}d.displayName="MDXCreateElement"},58991:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>c,frontMatter:()=>r,metadata:()=>i,toc:()=>p});var a=o(87462),n=(o(67294),o(3905));const r={},l="GCP BigQuery Composer",i={unversionedId:"storage/lab-bigquery-composer/README",id:"storage/lab-bigquery-composer/README",title:"GCP BigQuery Composer",description:"Cloud Composer - Copying BigQuery Tables Across Different Locations",source:"@site/docs/02-storage/lab-bigquery-composer/README.md",sourceDirName:"02-storage/lab-bigquery-composer",slug:"/storage/lab-bigquery-composer/",permalink:"/docs/storage/lab-bigquery-composer/",draft:!1,tags:[],version:"current",lastUpdatedBy:"sparsh",lastUpdatedAt:1681047270,formattedLastUpdatedAt:"Apr 9, 2023",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"BigQuery Commandline",permalink:"/docs/storage/lab-bigquery-commandline/"},next:{title:"BigQuery Data Warehousing",permalink:"/docs/storage/lab-bigquery-data-warehousing/"}},s={},p=[{value:"Objective",id:"objective",level:2},{value:"Introduction",id:"introduction",level:2},{value:"Step 1: Create Cloud Composer environment",id:"step-1-create-cloud-composer-environment",level:3},{value:"Step 2: Create Cloud Storage buckets",id:"step-2-create-cloud-storage-buckets",level:3},{value:"Step 3: BigQuery destination dataset",id:"step-3-bigquery-destination-dataset",level:3},{value:"Step 4: Defining the workflow",id:"step-4-defining-the-workflow",level:3},{value:"Step 5: Viewing environment information",id:"step-5-viewing-environment-information",level:3},{value:"Step 6: Setting DAGs Cloud Storage bucket",id:"step-6-setting-dags-cloud-storage-bucket",level:3},{value:"Step 7: Setting Airflow variables",id:"step-7-setting-airflow-variables",level:3},{value:"Step 8: Uploading the DAG and dependencies to Cloud Storage",id:"step-8-uploading-the-dag-and-dependencies-to-cloud-storage",level:3},{value:"Step 9: Using the Airflow UI",id:"step-9-using-the-airflow-ui",level:3},{value:"Step 10: Validate the results",id:"step-10-validate-the-results",level:3}],u={toc:p};function c(e){let{components:t,...o}=e;return(0,n.kt)("wrapper",(0,a.Z)({},u,o,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"gcp-bigquery-composer"},"GCP BigQuery Composer"),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"Cloud Composer - Copying BigQuery Tables Across Different Locations")),(0,n.kt)("h2",{id:"objective"},"Objective"),(0,n.kt)("p",null,"Copying BigQuery Tables Across Different Locations using Cloud Composer"),(0,n.kt)("h2",{id:"introduction"},"Introduction"),(0,n.kt)("p",null,"In this advanced lab, you will learn how to create and run an\xa0",(0,n.kt)("a",{parentName:"p",href:"http://airflow.apache.org/"},"Apache Airflow"),"\xa0workflow in Cloud Composer that completes the following tasks:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Reads from a config file the list of tables to copy"),(0,n.kt)("li",{parentName:"ul"},"Exports the list of tables from a\xa0",(0,n.kt)("a",{parentName:"li",href:"https://cloud.google.com/bigquery/docs/"},"BigQuery"),"\xa0dataset located in US to\xa0",(0,n.kt)("a",{parentName:"li",href:"https://cloud.google.com/storage/docs/"},"Cloud Storage")),(0,n.kt)("li",{parentName:"ul"},"Copies the exported tables from US to EU\xa0",(0,n.kt)("a",{parentName:"li",href:"https://cloud.google.com/storage/docs/"},"Cloud Storage"),"\xa0buckets"),(0,n.kt)("li",{parentName:"ul"},"Imports the list of tables into the target BigQuery Dataset in EU")),(0,n.kt)("h3",{id:"step-1-create-cloud-composer-environment"},"Step 1: Create Cloud Composer environment"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"First, create a Cloud Composer environment by clicking on\xa0Composer\xa0in the\xa0Navigation menu:"),(0,n.kt)("li",{parentName:"ol"},"Then click\xa0Create environment."),(0,n.kt)("li",{parentName:"ol"},"In dropdown menu, select\xa0Composer 1."),(0,n.kt)("li",{parentName:"ol"},"Set the following parameters for your environment:",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"Name:\xa0composer-advanced-lab"),(0,n.kt)("li",{parentName:"ul"},"Location:\xa0us-east1"),(0,n.kt)("li",{parentName:"ul"},"Zone:\xa0us-east1-c"),(0,n.kt)("li",{parentName:"ul"},"Leave all other settings as default."))),(0,n.kt)("li",{parentName:"ol"},"Click\xa0Create.")),(0,n.kt)("p",null,"The environment creation process is completed when the green checkmark displays to the left of the environment name on the Environments page in the Cloud Console."),(0,n.kt)("p",null,"Note:\xa0It can take up to\xa020 minutes\xa0for the environment to complete the setup process. Move on to the next section\xa0",(0,n.kt)("inlineCode",{parentName:"p"},"Create Cloud Storage buckets and BigQuery destination dataset"),"."),(0,n.kt)("h3",{id:"step-2-create-cloud-storage-buckets"},"Step 2: Create Cloud Storage buckets"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Create two Cloud Storage Multi-Regional buckets."),(0,n.kt)("li",{parentName:"ol"},"Give your two buckets a universally unique name including the location as a suffix:",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"one located in the US as\xa0",(0,n.kt)("em",{parentName:"li"},"source"),"\xa0(e.g. 6552634-us)"),(0,n.kt)("li",{parentName:"ul"},"the other located in EU as\xa0",(0,n.kt)("em",{parentName:"li"},"destination"),"\xa0(e.g. 6552634-eu)")))),(0,n.kt)("p",null,"Click\xa0Confirm\xa0for\xa0",(0,n.kt)("inlineCode",{parentName:"p"},"Public access will be prevented"),"\xa0pop-up if prompted."),(0,n.kt)("p",null,"These buckets will be used to copy the exported tables across locations, i.e., US to EU."),(0,n.kt)("h3",{id:"step-3-bigquery-destination-dataset"},"Step 3: BigQuery destination dataset"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Create the destination BigQuery Dataset in EU from the BigQuery new web UI."),(0,n.kt)("li",{parentName:"ol"},"Go to\xa0Navigation menu\xa0>\xa0BigQuery."),(0,n.kt)("li",{parentName:"ol"},"Click\xa0Done."),(0,n.kt)("li",{parentName:"ol"},"Then click the three dots next to your project ID and select\xa0Create dataset."),(0,n.kt)("li",{parentName:"ol"},"Use the name\xa0nyc_tlc_EU\xa0and Data location\xa0EU."),(0,n.kt)("li",{parentName:"ol"},"Click\xa0CREATE DATASET.")),(0,n.kt)("h3",{id:"step-4-defining-the-workflow"},"Step 4: Defining the workflow"),(0,n.kt)("p",null,"Cloud Composer workflows are comprised of\xa0",(0,n.kt)("a",{parentName:"p",href:"https://airflow.apache.org/docs/apache-airflow/1.10.15/concepts.html"},"DAGs (Directed Acyclic Graphs)"),". The code shown in\xa0",(0,n.kt)("a",{parentName:"p",href:"https://github.com/GoogleCloudPlatform/python-docs-samples/blob/16de3b44f1a9faeccca5bc1cd8a719afc104dc65/composer/workflows/bq_copy_across_locations.py"},"bq_copy_across_locations.py"),"\xa0is the workflow code, also referred to as the DAG. Open the file now to see how it is built. Next will be a detailed look at some of the key components of the file."),(0,n.kt)("p",null,"To orchestrate all the workflow tasks, the DAG imports the following operators:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("inlineCode",{parentName:"li"},"DummyOperator"),": Creates Start and End dummy tasks for better visual representation of the DAG."),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("inlineCode",{parentName:"li"},"BigQueryToCloudStorageOperator"),": Exports BigQuery tables to Cloud Storage buckets using Avro format."),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("inlineCode",{parentName:"li"},"GoogleCloudStorageToGoogleCloudStorageOperator"),": Copies files across Cloud Storage buckets."),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("inlineCode",{parentName:"li"},"GoogleCloudStorageToBigQueryOperator"),": Imports tables from Avro files in Cloud Storage bucket.")),(0,n.kt)("p",null,"In this example, the function\xa0",(0,n.kt)("inlineCode",{parentName:"p"},"read_master_file()"),"\xa0is defined to read the config file and build the list of tables to copy:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-py"},"# --------------------------------------------------------------------------------\n# Functions\n# --------------------------------------------------------------------------------\ndef read_table_list(table_list_file):\n    \"\"\"\n    Reads the master CSV file that will help in creating Airflow tasks in\n    the DAG dynamically.\n    :param table_list_file: (String) The file location of the master file,\n    e.g. '/home/airflow/framework/master.csv'\n    :return master_record_all: (List) List of Python dictionaries containing\n    the information for a single row in master CSV file.\n    \"\"\"\n    master_record_all = []\n    logger.info('Reading table_list_file from : %s' % str(table_list_file))\n    try:\n        with open(table_list_file, 'rb') as csv_file:\n            csv_reader = csv.reader(csv_file)\n            next(csv_reader)  # skip the headers\n            for row in csv_reader:\n                logger.info(row)\n                master_record = {\n                    'table_source': row[0],\n                    'table_dest': row[1]\n                }\n                master_record_all.append(master_record)\n            return master_record_all\n    except IOError as e:\n        logger.error('Error opening table_list_file %s: ' % str(\n            table_list_file), e)\n")),(0,n.kt)("p",null,"The name of the DAG is\xa0",(0,n.kt)("inlineCode",{parentName:"p"},"bq_copy_us_to_eu_01"),", and the DAG is not scheduled by default so needs to be triggered manually."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-py"},"default_args = {\n    'owner': 'airflow',\n    'start_date': datetime.today(),\n    'depends_on_past': False,\n    'email': [''],\n    'email_on_failure': False,\n    'email_on_retry': False,\n    'retries': 1,\n    'retry_delay': timedelta(minutes=5),\n}\n# DAG object.\nwith models.DAG('bq_copy_us_to_eu_01',\n                default_args=default_args,\n                schedule_interval=None) as dag:\n\n")),(0,n.kt)("p",null,"To define the Cloud Storage plugin, the class\xa0",(0,n.kt)("inlineCode",{parentName:"p"},"Cloud StoragePlugin(AirflowPlugin)"),"\xa0is defined, mapping the hook and operator downloaded from the Airflow 1.10-stable branch."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-py"},"# Import operator from plugins\nfrom gcs_plugin.operators import gcs_to_gcs\n")),(0,n.kt)("h3",{id:"step-5-viewing-environment-information"},"Step 5: Viewing environment information"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Go back to\xa0Composer\xa0to check on the status of your environment."),(0,n.kt)("li",{parentName:"ol"},"Once your environment has been created, click the name of the environment to see its details.")),(0,n.kt)("p",null,"The\xa0Environment details\xa0page provides information, such as the Airflow web UI URL, Google Kubernetes Engine cluster ID, name of the Cloud Storage bucket connected to the DAGs folder."),(0,n.kt)("p",null,"Note:\xa0Cloud Composer uses\xa0",(0,n.kt)("a",{parentName:"p",href:"https://cloud.google.com/storage"},"Cloud Storage"),"\xa0to store Apache Airflow DAGs, also known as\xa0",(0,n.kt)("em",{parentName:"p"},"workflows"),". Each environment has an associated Cloud Storage bucket. Cloud Composer schedules only the DAGs in the Cloud Storage bucket."),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Creating a virtual environment")),(0,n.kt)("p",null,"Note: Use Google Compute Shell"),(0,n.kt)("p",null,"Python virtual environments are used to isolate package installation from the system."),(0,n.kt)("p",null,"Install the\xa0",(0,n.kt)("inlineCode",{parentName:"p"},"virtualenv"),"\xa0environment:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"apt-get install -y virtualenv\n")),(0,n.kt)("p",null,"Note:\xa0If prompted ","[Y/n]",", press\xa0",(0,n.kt)("inlineCode",{parentName:"p"},"Y"),"\xa0and then\xa0",(0,n.kt)("inlineCode",{parentName:"p"},"Enter"),". If you get Permission denied error, then run the command\xa0",(0,n.kt)("inlineCode",{parentName:"p"},"sudo apt-get install -y virtualenv"),"."),(0,n.kt)("p",null,"Build the virtual environment:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"python3 -m venv venv\n")),(0,n.kt)("p",null,"Activate the virtual environment."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"source venv/bin/activate\n")),(0,n.kt)("h3",{id:"step-6-setting-dags-cloud-storage-bucket"},"Step 6: Setting DAGs Cloud Storage bucket"),(0,n.kt)("p",null,"In Cloud Shell, run the following to copy the name of the DAGs bucket from your Environment Details page and set a variable to refer to it in Cloud Shell:"),(0,n.kt)("p",null,"Note:\xa0Make sure to replace your DAGs bucket name in the following command. Navigate to\xa0Navigation menu\xa0>\xa0Storage, it will be similar to\xa0",(0,n.kt)("inlineCode",{parentName:"p"},"us-east1-composer-advanced-YOURDAGSBUCKET-bucket"),"."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"DAGS_BUCKET=YOURDAGSBUCKET\n")),(0,n.kt)("p",null,"You will be using this variable a few times during the lab."),(0,n.kt)("h3",{id:"step-7-setting-airflow-variables"},"Step 7: Setting Airflow variables"),(0,n.kt)("p",null,"Airflow variables are an Airflow-specific concept that is distinct from\xa0",(0,n.kt)("a",{parentName:"p",href:"https://cloud.google.com/composer/docs/how-to/managing/environment-variables"},"environment variables"),". In this step, you'll set the following three\xa0",(0,n.kt)("a",{parentName:"p",href:"https://airflow.apache.org/concepts.html#variables"},"Airflow variables"),"\xa0used by the DAG we will deploy:\xa0",(0,n.kt)("inlineCode",{parentName:"p"},"table_list_file_path"),",\xa0",(0,n.kt)("inlineCode",{parentName:"p"},"gcs_source_bucket"),", and\xa0",(0,n.kt)("inlineCode",{parentName:"p"},"gcs_dest_bucket"),"."),(0,n.kt)("table",null,(0,n.kt)("thead",{parentName:"table"},(0,n.kt)("tr",{parentName:"thead"},(0,n.kt)("th",{parentName:"tr",align:null},"Key"),(0,n.kt)("th",{parentName:"tr",align:null},"Value"),(0,n.kt)("th",{parentName:"tr",align:null},"Details"))),(0,n.kt)("tbody",{parentName:"table"},(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("inlineCode",{parentName:"td"},"table_list_file_path")),(0,n.kt)("td",{parentName:"tr",align:null},"/home/airflow/gcs/dags/bq","_","copy","_","eu","_","to","_","us","_","sample.csv"),(0,n.kt)("td",{parentName:"tr",align:null},"CSV file listing source and target tables, including dataset")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("inlineCode",{parentName:"td"},"gcs_source_bucket")),(0,n.kt)("td",{parentName:"tr",align:null},"{UNIQUE ID}-us"),(0,n.kt)("td",{parentName:"tr",align:null},"Cloud Storage bucket to use for exporting BigQuery tabledest","_","bbucks from source")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},(0,n.kt)("inlineCode",{parentName:"td"},"gcs_dest_bucket")),(0,n.kt)("td",{parentName:"tr",align:null},"{UNIQUE ID}-eu"),(0,n.kt)("td",{parentName:"tr",align:null},"Cloud Storage bucket to use for importing BigQuery tables at destination")))),(0,n.kt)("p",null,"The next\xa0",(0,n.kt)("inlineCode",{parentName:"p"},"gcloud composer"),"\xa0command executes the Airflow CLI sub-command\xa0",(0,n.kt)("a",{parentName:"p",href:"https://airflow.apache.org/docs/apache-airflow/stable/cli-and-env-variables-ref.html#variables"},"variables"),". The sub-command passes the arguments to the\xa0",(0,n.kt)("inlineCode",{parentName:"p"},"gcloud"),"\xa0command line tool."),(0,n.kt)("p",null,"To set the three variables, you will run the\xa0",(0,n.kt)("inlineCode",{parentName:"p"},"composer command"),"\xa0once for each row from the above table. The form of the command is this:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"gcloud composer environments run ENVIRONMENT_NAME\\\n--location LOCATION variables --\\\nset KEY VALUE\n")),(0,n.kt)("p",null,"You can safely ignore this gcloud error:\xa0",(0,n.kt)("inlineCode",{parentName:"p"},"(ERROR: gcloud crashed (TypeError): 'NoneType' object is not callable)"),". This is a\xa0",(0,n.kt)("a",{parentName:"p",href:"https://cloud.google.com/composer/docs/known-issues#gcloud-410"},"known issue"),"\xa0with using\xa0",(0,n.kt)("inlineCode",{parentName:"p"},"gcloud composer environments run"),"\xa0with the 410.0.0 version of gcloud. Your variables will still be set accordingly despite the error message."),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"ENVIRONMENT_NAME"),"\xa0is the name of the environment."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"LOCATION"),"\xa0is the Compute Engine region where the environment is located. The gcloud composer command requires including the\xa0",(0,n.kt)("inlineCode",{parentName:"li"},"--location"),"\xa0flag or\xa0",(0,n.kt)("a",{parentName:"li",href:"https://cloud.google.com/composer/docs/gcloud-installation"},"setting the default location"),"\xa0before running the gcloud command."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"KEY"),"\xa0and\xa0",(0,n.kt)("inlineCode",{parentName:"li"},"VALUE"),"\xa0specify the variable and its value to set. Include a space two dashes space (\xa0",(0,n.kt)("inlineCode",{parentName:"li"},"--"),"\xa0) between the left-side\xa0",(0,n.kt)("inlineCode",{parentName:"li"},"gcloud"),"\xa0command with gcloud-related arguments and the right-side Airflow sub-command-related arguments. Also include a space between the\xa0",(0,n.kt)("inlineCode",{parentName:"li"},"KEY"),"\xa0and\xa0",(0,n.kt)("inlineCode",{parentName:"li"},"VALUE"),"\xa0arguments. using the\xa0",(0,n.kt)("inlineCode",{parentName:"li"},"gcloud composer environments run"),"\xa0command with the variables sub-command in")),(0,n.kt)("p",null,"For example, the\xa0",(0,n.kt)("inlineCode",{parentName:"p"},"gcs_source_bucket"),"\xa0variable would be set like this:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"gcloud composer environments run composer-advanced-lab\\\n--location us-east1 variables --\\\nset gcs_source_bucket My_Bucket-us\n")),(0,n.kt)("p",null,"To see the value of a variable, run the Airflow CLI sub-command\xa0",(0,n.kt)("a",{parentName:"p",href:"https://airflow.apache.org/docs/apache-airflow/stable/cli-and-env-variables-ref.html#variables"},"variables"),"\xa0with the\xa0",(0,n.kt)("inlineCode",{parentName:"p"},"get"),"\xa0argument or use the\xa0",(0,n.kt)("a",{parentName:"p",href:"https://cloud.google.com/composer/docs/quickstart#variables-ui"},"Airflow UI"),"."),(0,n.kt)("p",null,"For example, run the following:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"gcloud composer environments run composer-advanced-lab\\\n    --location us-east1 variables --\\\n    get gcs_source_bucket\n")),(0,n.kt)("p",null,"Note: Make sure to set all three Airflow variables used by the DAG."),(0,n.kt)("h3",{id:"step-8-uploading-the-dag-and-dependencies-to-cloud-storage"},"Step 8: Uploading the DAG and dependencies to Cloud Storage"),(0,n.kt)("p",null,"Copy the Google Cloud Python docs samples files into your Cloud shell:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"cd ~\ngsutil -m cp -r gs://spls/gsp283/python-docs-samples .\n")),(0,n.kt)("p",null,"Upload a copy of the third party hook and operator to the plugins folder of your Composer DAGs Cloud Storage bucket:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"gsutil cp -r python-docs-samples/third_party/apache-airflow/plugins/* gs://$DAGS_BUCKET/plugins\n")),(0,n.kt)("p",null,"Next, upload the DAG and config file to the DAGs Cloud Storage bucket of your environment:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"gsutil cp python-docs-samples/composer/workflows/bq_copy_across_locations.py gs://$DAGS_BUCKET/dags\ngsutil cp python-docs-samples/composer/workflows/bq_copy_eu_to_us_sample.csv gs://$DAGS_BUCKET/dags\n")),(0,n.kt)("p",null,"Cloud Composer registers the DAG in your Airflow environment automatically, and DAG changes occur within 3-5 minutes. You can see task status in the Airflow web interface and confirm the DAG is not scheduled as per the settings."),(0,n.kt)("h3",{id:"step-9-using-the-airflow-ui"},"Step 9: Using the Airflow UI"),(0,n.kt)("p",null,"To access the Airflow web interface using the Cloud Console:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Go back to the Composer\xa0Environments\xa0page."),(0,n.kt)("li",{parentName:"ol"},"In the\xa0Airflow webserver\xa0column for the environment, click the\xa0Airflow\xa0link."),(0,n.kt)("li",{parentName:"ol"},"Click on your lab credentials."),(0,n.kt)("li",{parentName:"ol"},"The Airflow web UI opens in a new browser window. Data will still be loading when you get here. You can continue with the lab while this is happening.")),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Viewing variables")),(0,n.kt)("p",null,"The variables you set earlier are persisted in your environment."),(0,n.kt)("p",null,"View the variables by selecting\xa0Admin\xa0>Variables\xa0from the Airflow menu bar."),(0,n.kt)("p",null,(0,n.kt)("img",{parentName:"p",src:"https://user-images.githubusercontent.com/62965911/214003152-6d34e7ce-9760-4ee5-b3f6-0b0cf5f9e13b.png",alt:null})),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Trigger the DAG to run manually")),(0,n.kt)("p",null,"Click on the\xa0DAGs\xa0tab and wait for the links to finish loading."),(0,n.kt)("p",null,"To trigger the DAG manually, click the play button for\xa0",(0,n.kt)("inlineCode",{parentName:"p"},"composer_sample_bq_copy_across_locations"),"."),(0,n.kt)("p",null,"Click\xa0Trigger\xa0to confirm this action."),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Exploring DAG runs")),(0,n.kt)("p",null,"When you upload your DAG file to the DAGs folder in Cloud Storage, Cloud Composer parses the file. If no errors are found, the name of the workflow appears in the DAG listing, and the workflow is queued to run immediately if the schedule conditions are met, in this case, None as per the settings."),(0,n.kt)("p",null,"The\xa0DAG Runs\xa0status turns green once the play button is pressed:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Click the name of the DAG to open the DAG details page. This page includes a graphical representation of workflow tasks and dependencies."),(0,n.kt)("li",{parentName:"ol"},"Now, in the toolbar, click\xa0Graph, then mouseover the graphic for each task to see its status. Note that the border around each task also indicates the status (green border = running; red = failed, etc.).")),(0,n.kt)("p",null,"To run the workflow again from the\xa0Graph\xa0view:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"In the Airflow UI Graph View, click the\xa0start\xa0graphic."),(0,n.kt)("li",{parentName:"ol"},"Click\xa0Clear\xa0to reset all the tasks and then click\xa0OK\xa0to confirm.")),(0,n.kt)("p",null,"Refresh your browser while the process is running to see the most recent information."),(0,n.kt)("h3",{id:"step-10-validate-the-results"},"Step 10: Validate the results"),(0,n.kt)("p",null,"Now check the status and results of the workflow by going to these Cloud Console pages:"),(0,n.kt)("p",null,"The exported tables were copied from the US bucket to the EU Cloud Storage bucket. Click on\xa0Cloud Storage\xa0to see the intermediate Avro files in the source (US) and destination (EU) buckets."),(0,n.kt)("p",null,"The list of tables were imported into the target BigQuery Dataset. Click on\xa0BigQuery, then click on your project name and the\xa0nyc_tlc_EU\xa0dataset to validate the tables are accessible from the dataset you created."),(0,n.kt)("p",null,"Congratulations!"),(0,n.kt)("p",null,"You've have completed this advanced lab and copied 2 tables programmatically from US to EU! This lab is based on this\xa0",(0,n.kt)("a",{parentName:"p",href:"https://cloud.google.com/blog/products/data-analytics/how-to-transfer-bigquery-tables-between-locations-with-cloud-composer"},"blog post"),"\xa0by David Sabater Dinter."))}c.isMDXComponent=!0}}]);