"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[32121],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>m});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),d=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},c=function(e){var t=d(e.components);return n.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},p=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),p=d(a),m=r,h=p["".concat(s,".").concat(m)]||p[m]||u[m]||o;return a?n.createElement(h,i(i({ref:t},c),{},{components:a})):n.createElement(h,i({ref:t},c))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,i=new Array(o);i[0]=p;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var d=2;d<o;d++)i[d]=a[d];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}p.displayName="MDXCreateElement"},67438:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>d});var n=a(87462),r=(a(67294),a(3905));const o={},i="BigQuery Data Warehousing",l={unversionedId:"storage/lab-bigquery-data-warehousing/README",id:"storage/lab-bigquery-data-warehousing/README",title:"BigQuery Data Warehousing",description:"Objective",source:"@site/docs/02-storage/lab-bigquery-data-warehousing/README.md",sourceDirName:"02-storage/lab-bigquery-data-warehousing",slug:"/storage/lab-bigquery-data-warehousing/",permalink:"/docs/storage/lab-bigquery-data-warehousing/",draft:!1,tags:[],version:"current",lastUpdatedBy:"sparsh",lastUpdatedAt:1681047270,formattedLastUpdatedAt:"Apr 9, 2023",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"GCP BigQuery Composer",permalink:"/docs/storage/lab-bigquery-composer/"},next:{title:"GCP BigQuery ML",permalink:"/docs/storage/lab-bigquery-ml/"}},s={},d=[{value:"Objective",id:"objective",level:2},{value:"Create a new dataset to store your tables",id:"create-a-new-dataset-to-store-your-tables",level:3},{value:"Explore the product sentiment dataset",id:"explore-the-product-sentiment-dataset",level:3},{value:"Examine the data",id:"examine-the-data",level:3},{value:"Join datasets to find insights",id:"join-datasets-to-find-insights",level:3},{value:"Append additional records",id:"append-additional-records",level:3}],c={toc:d};function u(e){let{components:t,...a}=e;return(0,r.kt)("wrapper",(0,n.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"bigquery-data-warehousing"},"BigQuery Data Warehousing"),(0,r.kt)("h2",{id:"objective"},"Objective"),(0,r.kt)("p",null,"Creating a Data Warehouse Through Joins and Unions"),(0,r.kt)("p",null,"Scenario: Your marketing team provided you and your data science team all of the product reviews for your ecommerce website. You partner with them to create a data warehouse in BigQuery which joins together data from three sources:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Website ecommerce data"),(0,r.kt)("li",{parentName:"ul"},"Product inventory stock levels and lead times"),(0,r.kt)("li",{parentName:"ul"},"Product review sentiment analysis")),(0,r.kt)("p",null,"In this lab, you examine a new dataset based on product reviews."),(0,r.kt)("p",null,"The project with your marketing team's dataset is ",(0,r.kt)("inlineCode",{parentName:"p"},"data-to-insights"),". BigQuery public datasets are not displayed by default in BigQuery. The queries in this lab will use the data-to-insights dataset even though you cannot see it."),(0,r.kt)("p",null,"This lab focuses on how to create new reporting tables using SQL JOINS and UNIONs."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"What you'll do")),(0,r.kt)("p",null,"In this lab, you learn how to perform these tasks:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Explore new ecommerce data on sentiment analysis"),(0,r.kt)("li",{parentName:"ul"},"Join together datasets and create new tables"),(0,r.kt)("li",{parentName:"ul"},"Append historical data with unions and table wildcards")),(0,r.kt)("h3",{id:"create-a-new-dataset-to-store-your-tables"},"Create a new dataset to store your tables"),(0,r.kt)("p",null,"First, create a new dataset titled\xa0ecommerce\xa0in BigQuery."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"In the left pane, click on the name of your BigQuery project."),(0,r.kt)("li",{parentName:"ol"},"Click on the three dots next to your project name, then select\xa0CREATE DATASET."),(0,r.kt)("li",{parentName:"ol"},"The\xa0Create dataset\xa0dialog opens."),(0,r.kt)("li",{parentName:"ol"},"Set the\xa0",(0,r.kt)("em",{parentName:"li"},"Dataset ID"),"\xa0to\xa0",(0,r.kt)("inlineCode",{parentName:"li"},"ecommerce"),", leave all other options at their default values."),(0,r.kt)("li",{parentName:"ol"},"Click\xa0Create dataset."),(0,r.kt)("li",{parentName:"ol"},"Click on the\xa0Disable Editor Tabs\xa0link to enable the Query Editor.")),(0,r.kt)("h3",{id:"explore-the-product-sentiment-dataset"},"Explore the product sentiment dataset"),(0,r.kt)("p",null,"Your data science team has run all of your product reviews through the API and provided you with the average sentiment score and magnitude for each of your products."),(0,r.kt)("p",null,"First, create a copy the table that the data science team made so you can read it:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"create or replace TABLE ecommerce.products AS\nSELECT\n*\nFROM\n`data-to-insights.ecommerce.products`\n")),(0,r.kt)("p",null,"Note: This is only for you to review, the queries in this lab will be using the data-to-insights project."),(0,r.kt)("p",null,"Click on the ecommerce dataset to display the products table."),(0,r.kt)("h3",{id:"examine-the-data"},"Examine the data"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Navigate to the ecommerce > products dataset and click the Preview tab to see the data. How many Aluminum Handy Emergency Flashlight have been ordered? Options: 90/0/66/85"),(0,r.kt)("li",{parentName:"ol"},"Click the Schema tab. What data type are the sentimentScore and sentimentMagnitude fields? Options: INTERGER/FLOAT/RECORD/STRING"),(0,r.kt)("li",{parentName:"ol"},"Create a query that shows the top 5 products with the most positive sentiment. What product has the highest sentiment?",(0,r.kt)("ol",{parentName:"li",className:"contains-task-list"},(0,r.kt)("li",{parentName:"ol",className:"task-list-item"},(0,r.kt)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","G Noise-reducing Bluetooth Headphones"),(0,r.kt)("li",{parentName:"ol",className:"task-list-item"},(0,r.kt)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","G Noise-reducing Bluetooth Headphones"),(0,r.kt)("li",{parentName:"ol",className:"task-list-item"},(0,r.kt)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","Stylus Pen w/ LED Light"),(0,r.kt)("li",{parentName:"ol",className:"task-list-item"},(0,r.kt)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","USB wired soundbar - in store only",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\nSKU,\nname,\nsentimentScore,\nsentimentMagnitude\nFROM\n`data-to-insights.ecommerce.products`\nORDER BY\nsentimentScore DESC\nLIMIT 5\n"))))),(0,r.kt)("li",{parentName:"ol"},"Revise your query to show the top 5 products with the most negative sentiment and filter out NULL values. What is the product with the lowest sentiment? Options: Womens Convertible Vest-Jacket Sea Foam Green / 4 Womens Vintage Hero Tee Platinum / Mens Vintage Henley / 7 inch Dog Frisbee",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\nSKU,\nname,\nsentimentScore,\nsentimentMagnitude\nFROM\n`data-to-insights.ecommerce.products`\nWHERE sentimentScore IS NOT NULL\nORDER BY\nsentimentScore\nLIMIT 5\n")))),(0,r.kt)("h3",{id:"join-datasets-to-find-insights"},"Join datasets to find insights"),(0,r.kt)("p",null,"Scenario: It's the first of the month and your inventory team has informed you that the orderedQuantity field in the product inventory dataset is out of date. They need your help to query the total sales by product for 08/01/2017 and reference that against the current stock levels in inventory to see which products need to be resupplied first."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Calculate daily sales volume by productSKU")),(0,r.kt)("p",null,"Create a new table in your ecommerce dataset with the below requirements:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Title it sales_by_sku_20170801\nSource the data from data-to-insights.ecommerce.all_sessions_raw\nInclude only distinct results\nReturn productSKU\nReturn the total quantity ordered (productQuantity). Hint: Use a SUM() with a IFNULL condition\nFilter for only sales on 20170801\nORDER BY the SKUs with the most orders first\n")),(0,r.kt)("p",null,"Possible solution:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"# pull what sold on 08/01/2017\nCREATE OR REPLACE TABLE ecommerce.sales_by_sku_20170801 AS\nSELECT DISTINCT\nproductSKU,\nSUM(IFNULL(productQuantity,0)) AS total_ordered\nFROM\n`data-to-insights.ecommerce.all_sessions_raw`\nWHERE date = '20170801'\nGROUP BY productSKU\nORDER BY total_ordered DESC #462 skus sold\nCopied!\nClick on the sales_by_sku table, then click the Preview tab.\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Question: How many distinct product SKUs were sold? Answer: 462"),(0,r.kt)("li",{parentName:"ul"},"Question: True or false: GGOEGOAQ012899 is the top selling product SKU.")),(0,r.kt)("p",null,"Next, enrich your sales data with product inventory information by joining the two datasets."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Join sales data and inventory data")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Using a JOIN, enrich the website ecommerce data with the following fields from the product inventory dataset:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"name\nstockLevel\nrestockingLeadTime\nsentimentScore\nsentimentMagnitude\n"))),(0,r.kt)("li",{parentName:"ol"},"Complete the partially written query:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"# join against product inventory to get name\nSELECT DISTINCT\nwebsite.productSKU,\nwebsite.total_ordered,\ninventory.name,\ninventory.stockLevel,\ninventory.restockingLeadTime,\ninventory.sentimentScore,\ninventory.sentimentMagnitude\nFROM\necommerce.sales_by_sku_20170801 AS website\nLEFT JOIN `data-to-insights.ecommerce.products` AS inventory\nORDER BY total_ordered DESC\n")),"Possible solution:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"# join against product inventory to get name\nSELECT DISTINCT\nwebsite.productSKU,\nwebsite.total_ordered,\ninventory.name,\ninventory.stockLevel,\ninventory.restockingLeadTime,\ninventory.sentimentScore,\ninventory.sentimentMagnitude\nFROM\necommerce.sales_by_sku_20170801 AS website\nLEFT JOIN `data-to-insights.ecommerce.products` AS inventory\nON website.productSKU = inventory.SKU\nORDER BY total_ordered DESC\n"))),(0,r.kt)("li",{parentName:"ol"},"Modify the query you wrote to now include:",(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},'A calculated field of (total_ordered / stockLevel) and alias it "ratio". Hint: Use SAFE_DIVIDE(field1,field2) to avoid divide by 0 errors when the stock level is 0.'),(0,r.kt)("li",{parentName:"ol"},"Filter the results to only include products that have gone through 50% or more of their inventory already at the beginning of the month\nPossible solution:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"# calculate ratio and filter\nSELECT DISTINCT\nwebsite.productSKU,\nwebsite.total_ordered,\ninventory.name,\ninventory.stockLevel,\ninventory.restockingLeadTime,\ninventory.sentimentScore,\ninventory.sentimentMagnitude,\nSAFE_DIVIDE(website.total_ordered, inventory.stockLevel) AS ratio\nFROM\necommerce.sales_by_sku_20170801 AS website\nLEFT JOIN `data-to-insights.ecommerce.products` AS inventory\nON website.productSKU = inventory.SKU\n# gone through more than 50% of inventory for the month\nWHERE SAFE_DIVIDE(website.total_ordered,inventory.stockLevel) >= .50\nORDER BY total_ordered DESC\n")))))),(0,r.kt)("p",null,"Question: What is the name of the top selling product and what percent of its inventory has been sold already?"),(0,r.kt)("ul",{className:"contains-task-list"},(0,r.kt)("li",{parentName:"ul",className:"task-list-item"},(0,r.kt)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","Leather Journal-Black with 250 product orders out of 354 in stock"),(0,r.kt)("li",{parentName:"ul",className:"task-list-item"},(0,r.kt)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","Youth Short Sleeve Tee Red with a restocking leadtime of 9"),(0,r.kt)("li",{parentName:"ul",className:"task-list-item"},(0,r.kt)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","Android Infant Short Sleeve Tee Pewter with 7 product orders out of 2 in stock")),(0,r.kt)("h3",{id:"append-additional-records"},"Append additional records"),(0,r.kt)("p",null,"Your international team has already made in-store sales on 08/02/2017 which you want to record in your daily sales tables."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Create a new empty table to store sales by productSKU for 08/02/2017")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"For the schema, specify the following fields:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"table name is ecommerce.sales_by_sku_20170802\nproductSKU STRING\ntotal_ordered as an INT64 field\n")),"Possible solution:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE OR REPLACE TABLE ecommerce.sales_by_sku_20170802\n(\nproductSKU STRING,\ntotal_ordered INT64\n);\n"))),(0,r.kt)("li",{parentName:"ol"},"Confirm you now have two date-shared sales tables - use the dropdown menu next to the Sales_by_sku table name in the table results, or refresh your browser to see it listed in the left menu."),(0,r.kt)("li",{parentName:"ol"},"Insert the sales record provided to you by your sales team:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"INSERT INTO ecommerce.sales_by_sku_20170802\n(productSKU, total_ordered)\nVALUES('GGOEGHPA002910', 101)\n"))),(0,r.kt)("li",{parentName:"ol"},"Confirm the record appears by previewing the table - click on the table name to see the results.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Append together historical data")),(0,r.kt)("p",null,"There are multiple ways to append together data that has the same schema. Two common ways are using UNIONs and table wildcards."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Union is an SQL operator that appends together rows from different result sets."),(0,r.kt)("li",{parentName:"ul"},"Table wildcards enable you to query multiple tables using concise SQL statements. Wildcard tables are available only in standard SQL.")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Write a UNION query that will result in all records from the below two tables:",(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"ecommerce.sales_by_sku_20170801"),(0,r.kt)("li",{parentName:"ol"},"ecommerce.sales_by_sku_20170802",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT * FROM ecommerce.sales_by_sku_20170801\nUNION ALL\nSELECT * FROM ecommerce.sales_by_sku_20170802\n")),"Note: The difference between a UNION and UNION ALL is that a UNION will not include duplicate records.\nWhat is a pitfall of having many daily sales tables? You will have to write many UNION statements chained together.\nA better solution is to use the table wildcard filter and _TABLE_SUFFIX filter."))),(0,r.kt)("li",{parentName:"ol"},"Write a query that uses the (*) table wildcard to select all records from ecommerce.sales",(0,r.kt)("em",{parentName:"li"},"by_sku")," for the year 2017.\nPossible solution:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT * FROM `ecommerce.sales_by_sku_2017*`\n"))),(0,r.kt)("li",{parentName:"ol"},"Modify the previous query to add a filter to limit the results to just 08/02/2017.\nPossible solution:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT * FROM `ecommerce.sales_by_sku_2017*`\nWHERE _TABLE_SUFFIX = '0802'\n")))),(0,r.kt)("p",null,"Note: Another option to consider is to create a Partitioned Table which automatically can ingest daily sales data into the correct partition."),(0,r.kt)("p",null,"Congratulations!"),(0,r.kt)("p",null,"You explored sample ecommerce data by creating reporting tables and then manipulating views using SQL JOINs and UNIONs."))}u.isMDXComponent=!0}}]);