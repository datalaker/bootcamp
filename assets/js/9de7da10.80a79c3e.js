"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[92273],{3905:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>m});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},u=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),d=p(a),m=r,k=d["".concat(s,".").concat(m)]||d[m]||c[m]||l;return a?n.createElement(k,o(o({ref:t},u),{},{components:a})):n.createElement(k,o({ref:t},u))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=a.length,o=new Array(l);o[0]=d;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:r,o[1]=i;for(var p=2;p<l;p++)o[p]=a[p];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},14636:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>c,frontMatter:()=>l,metadata:()=>i,toc:()=>p});var n=a(87462),r=(a(67294),a(3905));const l={},o="Loading Taxi Data into Google Cloud SQL",i={unversionedId:"storage/lab-gcp-cloudsql-nyctaxi/README",id:"storage/lab-gcp-cloudsql-nyctaxi/README",title:"Loading Taxi Data into Google Cloud SQL",description:"Objective",source:"@site/docs/02-storage/lab-gcp-cloudsql-nyctaxi/README.md",sourceDirName:"02-storage/lab-gcp-cloudsql-nyctaxi",slug:"/storage/lab-gcp-cloudsql-nyctaxi/",permalink:"/docs/storage/lab-gcp-cloudsql-nyctaxi/",draft:!1,tags:[],version:"current",lastUpdatedBy:"sparsh",lastUpdatedAt:1681047270,formattedLastUpdatedAt:"Apr 9, 2023",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"db2",permalink:"/docs/storage/lab-db2-bookshop-petsale-data-ingestion/"},next:{title:"Lab - GCP Streaming Bigtable",permalink:"/docs/storage/lab-gcp-streaming-bigtable/"}},s={},p=[{value:"Objective",id:"objective",level:2},{value:"Preparing your environment",id:"preparing-your-environment",level:3},{value:"Create a Cloud SQL instance",id:"create-a-cloud-sql-instance",level:3},{value:"Add data to Cloud SQL instance",id:"add-data-to-cloud-sql-instance",level:3},{value:"Checking for data integrity",id:"checking-for-data-integrity",level:3}],u={toc:p};function c(e){let{components:t,...a}=e;return(0,r.kt)("wrapper",(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"loading-taxi-data-into-google-cloud-sql"},"Loading Taxi Data into Google Cloud SQL"),(0,r.kt)("h2",{id:"objective"},"Objective"),(0,r.kt)("p",null,"In this lab, you will learn how to import data from CSV text files into Cloud SQL and then carry out some basic data analysis using simple queries."),(0,r.kt)("p",null,"The dataset used in this lab is collected by the NYC Taxi and Limousine Commission and includes trip records from all trips completed in Yellow and Green taxis in NYC from 2009 to present, and all trips in for-hire vehicles (FHV) from 2015 to present. Records include fields capturing pick-up and drop-off dates/times, pick-up and drop-off locations, trip distances, itemized fares, rate types, payment types, and driver-reported passenger counts."),(0,r.kt)("p",null,"In this lab, we will:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Create Cloud SQL instance"),(0,r.kt)("li",{parentName:"ul"},"Create a Cloud SQL database"),(0,r.kt)("li",{parentName:"ul"},"Import text data into Cloud SQL"),(0,r.kt)("li",{parentName:"ul"},"Check the data for integrity")),(0,r.kt)("h3",{id:"preparing-your-environment"},"Preparing your environment"),(0,r.kt)("p",null,"Create environment variables that will be used later in the lab for your project ID and the storage bucket that will contain your data:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"export PROJECT_ID=$(gcloud info --format='value(config.project)')\nexport BUCKET=${PROJECT_ID}-ml\n")),(0,r.kt)("h3",{id:"create-a-cloud-sql-instance"},"Create a Cloud SQL instance"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Enter the following commands to create a Cloud SQL instance:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"gcloud sql instances create taxi \\\n    --tier=db-n1-standard-1 --activation-policy=ALWAYS\n")),(0,r.kt)("p",null,"This will take a few minutes to complete."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Set a root password for the Cloud SQL instance:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"gcloud sql users set-password root --host % --instance taxi\\\n --password Passw0rd\n")),(0,r.kt)("p",null,"When prompted for the password type\xa0",(0,r.kt)("inlineCode",{parentName:"p"},"Passw0rd"),"\xa0and press enter this will update root password."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Now create an environment variable with the IP address of the Cloud Shell:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"export ADDRESS=$(wget -qO - http://ipecho.net/plain)/32\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Whitelist the Cloud Shell instance for management access to your SQL instance:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"gcloud sql instances patch taxi --authorized-networks $ADDRESS\n")),(0,r.kt)("p",null,"When prompted press\xa0Y\xa0to accept the change."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Get the IP address of your Cloud SQL instance by running:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'MYSQLIP=$(gcloud sql instances describe taxi --format="value(ipAddresses.ipAddress)")\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Check the variable MYSQLIP:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"echo $MYSQLIP\n")),(0,r.kt)("p",null,"You should get an IP address as an output."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Create the taxi trips table by logging into the\xa0",(0,r.kt)("inlineCode",{parentName:"li"},"mysql"),"\xa0command line interface:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"mysql --host=$MYSQLIP --user=root --password --verbose\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"When prompted for a password enter\xa0",(0,r.kt)("inlineCode",{parentName:"li"},"Passw0rd"),"."),(0,r.kt)("li",{parentName:"ul"},"Paste the following content into the command line to create the schema for the\xa0",(0,r.kt)("inlineCode",{parentName:"li"},"trips"),"\xa0table:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"create database if not exists bts;\nuse bts;\ndrop table if exists trips;\ncreate table trips (\n  vendor_id VARCHAR(16),    \n  pickup_datetime DATETIME,\n  dropoff_datetime DATETIME,\n  passenger_count INT,\n  trip_distance FLOAT,\n  rate_code VARCHAR(16),\n  store_and_fwd_flag VARCHAR(16),\n  payment_type VARCHAR(16),\n  fare_amount FLOAT,\n  extra FLOAT,\n  mta_tax FLOAT,\n  tip_amount FLOAT,\n  tolls_amount FLOAT,\n  imp_surcharge FLOAT,\n  total_amount FLOAT,\n  pickup_location_id VARCHAR(16),\n  dropoff_location_id VARCHAR(16)\n);\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"In the mysql command line interface check the import by entering the following commands:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"describe trips;\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Query the trips table:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"select distinct(pickup_location_id) from trips;\n")),(0,r.kt)("p",null,"This will return an empty set as there is no data in the database yet."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Exit the mysql interactive console:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"exit\n")),(0,r.kt)("h3",{id:"add-data-to-cloud-sql-instance"},"Add data to Cloud SQL instance"),(0,r.kt)("p",null,"Now you'll copy the New York City taxi trips CSV files stored on Cloud Storage locally. To keep resource usage low, you'll only be working with a subset of the data (~20,000 rows)."),(0,r.kt)("p",null,"Run the following in the command line:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"gsutil cp gs://cloud-training/OCBL013/nyc_tlc_yellow_trips_2018_subset_1.csv trips.csv-1\ngsutil cp gs://cloud-training/OCBL013/nyc_tlc_yellow_trips_2018_subset_2.csv trips.csv-2\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Connect to the mysql interactive console to load local infile data:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"mysql --host=$MYSQLIP --user=root  --password  --local-infile\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"When prompted for a password enter ",(0,r.kt)("inlineCode",{parentName:"li"},"Passw0rd"),"."),(0,r.kt)("li",{parentName:"ul"},"In the mysql interactive console select the database:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"use bts;\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Load the local CSV file data using local-infile:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"LOAD DATA LOCAL INFILE 'trips.csv-1' INTO TABLE trips\nFIELDS TERMINATED BY ','\nLINES TERMINATED BY '\\n'\nIGNORE 1 LINES\n(vendor_id,pickup_datetime,dropoff_datetime,passenger_count,trip_distance,rate_code,store_and_fwd_flag,payment_type,fare_amount,extra,mta_tax,tip_amount,tolls_amount,imp_surcharge,total_amount,pickup_location_id,dropoff_location_id);\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"LOAD DATA LOCAL INFILE 'trips.csv-2' INTO TABLE trips\nFIELDS TERMINATED BY ','\nLINES TERMINATED BY '\\n'\nIGNORE 1 LINES\n(vendor_id,pickup_datetime,dropoff_datetime,passenger_count,trip_distance,rate_code,store_and_fwd_flag,payment_type,fare_amount,extra,mta_tax,tip_amount,tolls_amount,imp_surcharge,total_amount,pickup_location_id,dropoff_location_id);\n")),(0,r.kt)("h3",{id:"checking-for-data-integrity"},"Checking for data integrity"),(0,r.kt)("p",null,"Whenever data is imported from a source it's always important to check for data integrity. Roughly, this means making sure the data meets your expectations."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Query the trips table for unique pickup location regions:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"select distinct(pickup_location_id) from trips;\n")),(0,r.kt)("p",null,"This should return 159 unique ids."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Let's start by digging into the trip_distance column. Enter the following query into the console:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"select\n  max(trip_distance),\n  min(trip_distance)\nfrom\n  trips;\n")),(0,r.kt)("p",null,"One would expect the trip distance to be greater than 0 and less than, say 1000 miles. The maximum trip distance returned of 85 miles seems reasonable but the minimum trip distance of 0 seems buggy."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"How many trips in the dataset have a trip distance of 0?")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"select count(*) from trips where trip_distance = 0;\n")),(0,r.kt)("p",null,"There are 155 such trips in the database. These trips warrant further exploration. You'll find that these trips have non-zero payment amounts associated with them. Perhaps these are fraudulent transactions?"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Let's see if we can find more data that doesn't meet our expectations. We expect the fare_amount column to be positive. Enter the following query to see if this is true in the database:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"select count(*) from trips where fare_amount < 0;\n")),(0,r.kt)("p",null,"There should be 14 such trips returned. Again, these trips warrant further exploration. There may be a reasonable explanation for why the fares take on negative numbers. However, it's up to the data engineer to ensure there are no bugs in the data pipeline that would cause such a result."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Finally, let's investigate the payment_type column.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"select\n  payment_type,\n  count(*)\nfrom\n  trips\ngroup by\n  payment_type;\n")),(0,r.kt)("p",null,"The results of the query indicate that there are four different payment types, with:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Payment type = 1 has 13863 rows"),(0,r.kt)("li",{parentName:"ul"},"Payment type = 2 has 6016 rows"),(0,r.kt)("li",{parentName:"ul"},"Payment type = 3 has 113 rows"),(0,r.kt)("li",{parentName:"ul"},"Payment type = 4 has 32 rows")),(0,r.kt)("p",null,"Digging into ",(0,r.kt)("a",{parentName:"p",href:"https://www1.nyc.gov/assets/tlc/downloads/pdf/data_dictionary_trip_records_yellow.pdf"},"the documentation"),", a payment type of 1 refers to credit card use, payment type of 2 is cash, and a payment type of 4 refers to a dispute. The figures make sense."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Exit the 'mysql' interactive console:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"exit\n")))}c.isMDXComponent=!0}}]);