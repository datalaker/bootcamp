"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[42236],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=c(n),h=r,m=d["".concat(s,".").concat(h)]||d[h]||p[h]||o;return n?a.createElement(m,i(i({ref:t},u),{},{components:n})):a.createElement(m,i({ref:t},u))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var c=2;c<o;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},57573:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>c});var a=n(87462),r=(n(67294),n(3905));const o={},i="Deploying a NodeJS app in Kubernetes",l={unversionedId:"devops/containers/lab-kubernetes-kubia-app/README",id:"devops/containers/lab-kubernetes-kubia-app/README",title:"Deploying a NodeJS app in Kubernetes",description:"NodeJS App",source:"@site/docs/07-devops/containers/lab-kubernetes-kubia-app/README.md",sourceDirName:"07-devops/containers/lab-kubernetes-kubia-app",slug:"/devops/containers/lab-kubernetes-kubia-app/",permalink:"/docs/devops/containers/lab-kubernetes-kubia-app/",draft:!1,tags:[],version:"current",lastUpdatedBy:"sparsh",lastUpdatedAt:1681047270,formattedLastUpdatedAt:"Apr 9, 2023",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Deploy Docker in ECS",permalink:"/docs/devops/containers/lab-deploy-simple-docker-ecs/"},next:{title:"FastAPI",permalink:"/docs/devops/fastapi/"}},s={},c=[{value:"NodeJS App",id:"nodejs-app",level:2},{value:"Creating a Dockerfile for the image",id:"creating-a-dockerfile-for-the-image",level:2},{value:"Building the container image",id:"building-the-container-image",level:2},{value:"Running the container image",id:"running-the-container-image",level:2},{value:"Push the image to Dockerhub",id:"push-the-image-to-dockerhub",level:2},{value:"Docker commands",id:"docker-commands",level:2},{value:"Running the image on a different machine",id:"running-the-image-on-a-different-machine",level:2},{value:"Kubernetes commands",id:"kubernetes-commands",level:2},{value:"Start the cluster",id:"start-the-cluster",level:2},{value:"Deploying your Node.js app",id:"deploying-your-nodejs-app",level:2},{value:"Behind the scenes",id:"behind-the-scenes",level:2},{value:"Accessing your web application",id:"accessing-your-web-application",level:2}],u={toc:c};function p(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"deploying-a-nodejs-app-in-kubernetes"},"Deploying a NodeJS app in Kubernetes"),(0,r.kt)("h2",{id:"nodejs-app"},"NodeJS App"),(0,r.kt)("p",null,"It starts up an HTTP server on port 8080. The server responds with an HTTP response status code 200 OK and the text ",(0,r.kt)("inlineCode",{parentName:"p"},"You've hit <hostname>")," to every request. The request handler also logs the client\u2019s IP address to the standard output, which you\u2019ll need later. The returned hostname is the server\u2019s actual hostname, not the one the client sends in the HTTP request\u2019s Host header."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'const http = require(\'http\');\nconst os = require(\'os\');\n\nconsole.log("Kubia server starting...");\n\nvar handler = function(request, response) {\n  console.log("Received request from " + request.connection.remoteAddress);\n  response.writeHead(200);\n  response.end("You\'ve hit " + os.hostname() + "\\n");\n};\n\nvar www = http.createServer(handler);\nwww.listen(8080);\n')),(0,r.kt)("h2",{id:"creating-a-dockerfile-for-the-image"},"Creating a Dockerfile for the image"),(0,r.kt)("p",null,"To package your app into an image, you first need to create a file called Dockerfile, which will contain a list of instructions that Docker will perform when building the image. The Dockerfile needs to be in the same directory as the app.js file."),(0,r.kt)("h2",{id:"building-the-container-image"},"Building the container image"),(0,r.kt)("p",null,"Now that you have your Dockerfile and the app.js file, you have everything you need to build your image."),(0,r.kt)("p",null,"You\u2019re telling Docker to build an image called kubia based on the contents of the current directory. Docker will look for the Dockerfile in the directory and build the image based on the instructions in the file."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://user-images.githubusercontent.com/62965911/211507784-57bd3cc2-e83e-4c96-a8cb-b913a4aa5a67.png",alt:"build"})),(0,r.kt)("p",null,"The build process isn\u2019t performed by the Docker client. Instead, the contents of the whole directory are uploaded to the Docker daemon and the image is built there. The client and daemon don\u2019t need to be on the same machine at all. If you\u2019re using Docker on a non-Linux OS, the client is on your host OS, but the daemon runs inside a VM. Because all the files in the build directory are uploaded to the daemon, if it contains many large files and the daemon isn\u2019t running locally, the upload may take longer."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Tip: You can see the list of locally-stored docker images by running ",(0,r.kt)("inlineCode",{parentName:"p"},"$ docker images")," command.")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Note: Container images are composed of layers that can be shared among different images.")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://user-images.githubusercontent.com/62965911/211507811-203b78ee-ac64-4193-a3e8-b2d9dda775b3.png",alt:"docker-layers"})),(0,r.kt)("h2",{id:"running-the-container-image"},"Running the container image"),(0,r.kt)("p",null,"You can now run your image with the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"docker run --name kubia-container -p 8080:8080 -d kubia\n")),(0,r.kt)("p",null,"This tells Docker to run a new container called kubia-container from the kubia image. The container will be detached from the console (-d flag), which means it will run in the background. Port 8080 on the local machine will be mapped to port 8080 inside the container (-p 8080:8080 option), so you can access the app through http://localhost:8080."),(0,r.kt)("h2",{id:"push-the-image-to-dockerhub"},"Push the image to Dockerhub"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"docker tag kubia:latest sparshai/kubia:latest\ndocker push sparshai/kubia\n")),(0,r.kt)("h2",{id:"docker-commands"},"Docker commands"),(0,r.kt)("p",null,"Here are some handy commands:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"$ curl localhost:8080")," for accessing your app."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"$ docker ps")," for listing all the running containers."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"$ docker inspect kubia-container")," for more detailed information"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"$ docker exec -it kubia-container bash")," for starting docker shell"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"$ ps aux")," for listing running processes inside docker"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"$ docker stop kubia-container")," for stopping the container"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"$ docker rm kubia-container")," for deleting the container"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"$ docker push <your-id>/kubia")," for pushing image to DockerHub.")),(0,r.kt)("h2",{id:"running-the-image-on-a-different-machine"},"Running the image on a different machine"),(0,r.kt)("p",null,"After the push to Docker Hub is complete, the image will be available to everyone. You can now run the image on any machine running Docker by executing the following command: ",(0,r.kt)("inlineCode",{parentName:"p"},"$ docker run -p 8080:8080 -d luksa/kubia"),"."),(0,r.kt)("p",null,"It doesn\u2019t get much simpler than that. And the best thing about this is that your application will have the exact same environment every time and everywhere it\u2019s run. If it ran fine on your machine, it should run as well on every other Linux machine. No need to worry about whether the host machine has Node.js installed or not. In fact, even if it does, your app won\u2019t use it, because it will use the one installed inside the image."),(0,r.kt)("h2",{id:"kubernetes-commands"},"Kubernetes commands"),(0,r.kt)("p",null,"Here are some handy commands:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"$ kubectl get nodes")," for listing cluster nodes"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"$ kubectl describe node xxx-kubia-85f6-node-0rrx")," for retrieving additional details of an object"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"$ alias k=kubectl")," to create alias for kubectl command"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"$ kubectl get pods")," for listing pods"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"$ kubectl get services")," for listing services")),(0,r.kt)("h2",{id:"start-the-cluster"},"Start the cluster"),(0,r.kt)("p",null,"First step is to initialize the cluster in the first terminal:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"kubeadm init --apiserver-advertise-address $(hostname -i)\n")),(0,r.kt)("p",null,"That means you\u2019re almost ready to go. Last you just have to initialize your cluster networking in the first terminal:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"kubectl apply -n kube-system -f \"https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 |tr -d '\\n')\"\n")),(0,r.kt)("p",null,"To join other nodes as workers to the master node, run command like the following that you will receive from the master terminal after starting the cluster."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"kubeadm join 192.168.0.33:6443 --token 20l5u8.pekij3hq5xzux7h9 \\\n    --discovery-token-ca-cert-hash sha256:572d36c75cd7456302c44886f4ae99514956c99cef3db7a50be7ed78080f5a77\n")),(0,r.kt)("h2",{id:"deploying-your-nodejs-app"},"Deploying your Node.js app"),(0,r.kt)("p",null,"The simplest way to deploy your app is to use the kubectl run command, which will create all the necessary components without having to deal with JSON or YAML. This way, we don\u2019t need to dive into the structure of each object yet. Try to run the image you created and pushed to Docker Hub earlier. Here\u2019s how to run it in Kubernetes:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"kubectl create deployment kubia-app --image=sparshai/kubia --port=8080\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Tip: Check the status by running ",(0,r.kt)("inlineCode",{parentName:"p"},"$ k get pods")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"$ k describe pods")," for more detailed info.")),(0,r.kt)("h2",{id:"behind-the-scenes"},"Behind the scenes"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://user-images.githubusercontent.com/62965911/211507804-1c3d09cd-130e-49e4-90de-f3f91c312da4.png",alt:"deploy-process"})),(0,r.kt)("h2",{id:"accessing-your-web-application"},"Accessing your web application"),(0,r.kt)("p",null,"With your pod running, how do you access it? We mentioned that each pod gets its own IP address, but this address is internal to the cluster and isn\u2019t accessible from outside of it. To make the pod accessible from the outside, you\u2019ll expose it through a Service object. You\u2019ll create a special service of type LoadBalancer, because if you create a regular service (a ClusterIP service), like the pod, it would also only be accessible from inside the cluster. By creating a LoadBalancer-type service, an external load balancer will be created and you can connect to the pod through the load balancer\u2019s public IP."),(0,r.kt)("p",null,"To create the service, you\u2019ll tell Kubernetes to expose the ReplicationController you created earlier:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"kubectl expose deployment kubia-app --type LoadBalancer --port 80 --target-port 8080\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Tip: ",(0,r.kt)("inlineCode",{parentName:"p"},"k get services")," to get list of running services.")))}p.isMDXComponent=!0}}]);