<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-processing/lab-gcp-dataflow-batch-pipeline">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Lab: GCP Dataflow Batch Pipeline | Recohut Data Bootcamp</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://www.recohut.com/docs/processing/lab-gcp-dataflow-batch-pipeline"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="keywords" content="data science, data engineering, data analytics"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Lab: GCP Dataflow Batch Pipeline | Recohut Data Bootcamp"><meta data-rh="true" name="description" content="Objective: Serverless Data Processing with Dataflow - Batch Analytics Pipelines with Cloud Dataflow (Python)"><meta data-rh="true" property="og:description" content="Objective: Serverless Data Processing with Dataflow - Batch Analytics Pipelines with Cloud Dataflow (Python)"><link data-rh="true" rel="icon" href="/img/branding/favicon-black.svg"><link data-rh="true" rel="canonical" href="https://www.recohut.com/docs/processing/lab-gcp-dataflow-batch-pipeline"><link data-rh="true" rel="alternate" href="https://www.recohut.com/docs/processing/lab-gcp-dataflow-batch-pipeline" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.recohut.com/docs/processing/lab-gcp-dataflow-batch-pipeline" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Recohut Data Bootcamp RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Recohut Data Bootcamp Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-B4S1B1ZDTT"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-B4S1B1ZDTT",{})</script><link rel="stylesheet" href="/assets/css/styles.099cbecb.css">
<link rel="preload" href="/assets/js/runtime~main.40c54d56.js" as="script">
<link rel="preload" href="/assets/js/main.dbd2f5fe.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/branding/favicon-color.svg" alt="Recohut Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/branding/favicon-color.svg" alt="Recohut Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Bootcamp</b></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/sparsh-ai/recohut" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_Pkmr"><kbd class="searchHint_iIMx">ctrl</kbd><kbd class="searchHint_iIMx">K</kbd></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/introduction">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/getting-started">Getting Started</a><button aria-label="Toggle the collapsible sidebar category &#x27;Getting Started&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/foundations/cloud/cloud-computing">Cloud Computing</a><button aria-label="Toggle the collapsible sidebar category &#x27;Cloud Computing&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/foundations/language/sql/sql-basics">Programming</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/storage/serialization">Data Storage</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/processing/databricks">Data Processing</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/processing/databricks">Databricks</a><button aria-label="Toggle the collapsible sidebar category &#x27;Databricks&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/processing/aws-emr">AWS EMR</a><button aria-label="Toggle the collapsible sidebar category &#x27;AWS EMR&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/processing/lab-glue-advanced">AWS Glue Studio</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/processing/aws-lambda">AWS Lambda Function</a><button aria-label="Toggle the collapsible sidebar category &#x27;AWS Lambda Function&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/processing/aws-kinesis">Amazon Kinesis</a><button aria-label="Toggle the collapsible sidebar category &#x27;Amazon Kinesis&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/processing/apache-beam">Apache Beam</a><button aria-label="Toggle the collapsible sidebar category &#x27;Apache Beam&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/processing/lab-gcp-dataflow-pipeline">GCP Dataflow</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/processing/lab-gcp-dataflow-pipeline">Lab: GCP Dataflow Pipeline - A Simple Dataflow Pipeline (Python)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/processing/lab-gcp-dataflow-batch-pipeline">Lab: GCP Dataflow Batch Pipeline</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/processing/lab-gcp-dataflow-side-inputs">Lab: GCP Dataflow Size Inputs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/processing/lab-gcp-dataflow-stream-pipeline">GCP Dataflow Streaming Pipeline</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/processing/lab-gcp-serverless-dataflow">Lab: GCP Serverless Dataflow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/processing/lab-dataflow-bigquery-etl">Lab: ETL Processing on Google Cloud Using Dataflow and BigQuery</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/processing/ray">Ray</a><button aria-label="Toggle the collapsible sidebar category &#x27;Ray&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/processing/gcp-dataproc">GCP Dataproc</a><button aria-label="Toggle the collapsible sidebar category &#x27;GCP Dataproc&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/processing/lab-azure-hdinsight-simple-data-processing">Azure HDInsight</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/processing/azure-synapse-analytics">Azure Synapse Analytics</a><button aria-label="Toggle the collapsible sidebar category &#x27;Azure Synapse Analytics&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/processing/lab-gcp-dataprep">GCP Dataprep</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/processing/gcp-pubsub">GCP PubSub</a><button aria-label="Toggle the collapsible sidebar category &#x27;GCP PubSub&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/processing/apache-kafka">Apache Kafka</a><button aria-label="Toggle the collapsible sidebar category &#x27;Apache Kafka&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/processing/apache-flink">Apache Flink</a><button aria-label="Toggle the collapsible sidebar category &#x27;Apache Flink&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/processing/dbt">dbt</a><button aria-label="Toggle the collapsible sidebar category &#x27;dbt&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/processing/snowpark">Snowpark</a><button aria-label="Toggle the collapsible sidebar category &#x27;Snowpark&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/data-modeling">Data Modeling</a><button aria-label="Toggle the collapsible sidebar category &#x27;Data Modeling&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/extraction/api">Data Extraction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/orchestration/airflow">Data Pipelines</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/visualization/flask">Data Visualization</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/devops">DevOps</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/mathematics">Mathematics</a><button aria-label="Toggle the collapsible sidebar category &#x27;Mathematics&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/foundations/basics/origin">Data Science</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/category/case-studies">Extras</a></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Data Processing</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">GCP Dataflow</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Lab: GCP Dataflow Batch Pipeline</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Lab: GCP Dataflow Batch Pipeline</h1><p>Objective: Serverless Data Processing with Dataflow - Batch Analytics Pipelines with Cloud Dataflow (Python)</p><p>In this lab, you:</p><ul><li>Write a pipeline that aggregates site traffic by user.</li><li>Write a pipeline that aggregates site traffic by minute.</li><li>Implement windowing on time series data.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="preparation">Preparation<a class="hash-link" href="#preparation" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="jupyter-notebook-based-development-environment-setup">Jupyter notebook-based development environment setup<a class="hash-link" href="#jupyter-notebook-based-development-environment-setup" title="Direct link to heading">​</a></h3><ul><li>In the Console, expand the Navigation menu (Navigation menu icon), then select Vertex AI &gt; Workbench.</li><li>Enable Notebooks API.</li><li>At the top of the page click New Notebook, and select Smart Analytics Framework &gt; Apache Beam &gt; Without GPUs</li><li>In the dialog box that appears, set the region to us-central1 and then click CREATE at the bottom.</li><li>Once the environment is ready, click the OPEN JUPYTERLAB link next to your Notebook name. This will open up your environment in a new tab in your browser.</li><li>Next, click Terminal. This will open up a terminal where you can run all the commands in this lab.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="download-code-repository">Download Code Repository<a class="hash-link" href="#download-code-repository" title="Direct link to heading">​</a></h3><p>Next you will download a code repository for use in this lab.</p><ul><li>In the terminal you just opened, enter the following:</li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/GoogleCloudPlatform/training-data-analyst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd /home/jupyter/training-data-analyst/quests/dataflow_python/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>On the left panel of your notebook environment, in the file browser, you will notice the training-data-analyst repo added.</p></li><li><p>Navigate into the cloned repo /training-data-analyst/quests/dataflow_python/. You will see a folder for each lab, which is further divided into a lab sub-folder with code to be completed by you, and a solution sub-folder with a fully workable example to reference if you get stuck.</p></li></ul><p>Note: To open a file for editing purposes, simply navigate to the file and click on it. This will open the file, where you can add or modify code.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aggregating-site-traffic-by-user">Aggregating site traffic by user<a class="hash-link" href="#aggregating-site-traffic-by-user" title="Direct link to heading">​</a></h2><p>In this part of the lab, you write a pipeline that:</p><ol><li>Reads the day&#x27;s traffic from a file in Cloud Storage.</li><li>Converts each event into a <code>CommonLog</code> object.</li><li>Sums the number of hits for each unique user by grouping each object by user ID and combining the values to get the total number of hits for that particular user.</li><li>Performs additional aggregations on each user.</li><li>Writes the resulting data to BigQuery.</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-1-generate-synthetic-data">Task 1. Generate synthetic data<a class="hash-link" href="#task-1-generate-synthetic-data" title="Direct link to heading">​</a></h3><p>The first step is to generate data for the pipeline to process. You will open the lab environment and generate the data:</p><p>In the terminal in your IDE environment, run the following commands:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd 3_Batch_Analytics/lab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export BASE_DIR=$(pwd)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Before you can begin editing the actual pipeline code, you need to ensure that you have installed the necessary dependencies. Execute the following to create a virtual environment for your work in this lab:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt-get update &amp;&amp; sudo apt-get install -y python3-venv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 -m venv df-env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source df-env/bin/activate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 -m pip install -q --upgrade pip setuptools wheel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 -m pip install apache-beam[gcp]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud services enable dataflow.googleapis.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Create GCS buckets and BQ dataset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd $BASE_DIR/../..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source create_batch_sinks.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Generate event dataflow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source generate_batch_events.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Change to the directory containing the practice version of the code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd $BASE_DIR</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The script creates a file called <code>events.json</code> containing lines resembling the following:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;user_id&quot;: &quot;-6434255326544341291&quot;, &quot;ip&quot;: &quot;192.175.49.116&quot;, &quot;timestamp&quot;: &quot;2019-06-19T16:06:45.118306Z&quot;, &quot;http_request&quot;: &quot;\&quot;GET eucharya.html HTTP/1.0\&quot;&quot;, &quot;lat&quot;: 37.751, &quot;lng&quot;: -97.822, &quot;http_response&quot;: 200, &quot;user_agent&quot;: &quot;Mozilla/5.0 (compatible; MSIE 7.0; Windows NT 5.01; Trident/5.1)&quot;, &quot;num_bytes&quot;: 182}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It then automatically copies this file to your Google Cloud Storage bucket at <code>Cloud Storage path</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-2-sum-page-views-per-user">Task 2. Sum page views per user<a class="hash-link" href="#task-2-sum-page-views-per-user" title="Direct link to heading">​</a></h3><p>In the file explorer, navigate to <code>training-data-analyst/quest/dataflow_python/3_Batch_Analytics/lab</code> and open the <code>batch_user_traffic_pipeline.py</code> file. This pipeline already contains the necessary code to accept command-line options for the input path and the output table name, as well as code to read in events from Google Cloud Storage, parse those events, and write results to BigQuery. However, some important parts are missing.</p><p>The next step in the pipeline is to aggregate the events by each unique <code>user_id</code> and count page views for each. An easy way to do this on objects of type <code>beam.Row</code> or objects with a Beam schema is to use the <code>GroupBy</code> transform and then perform some aggregations on the resulting group. For example: <code>purchases | GroupBy(&#x27;user_id&#x27;, &#x27;address&#x27;)</code> will return a PCollection of rows with two fields.</p><p>The first is a <code>Row</code> with schema representing every unique combination of <code>&#x27;user_id&#x27;</code> and <code>address</code> (both strings), &quot;key&quot;, and &quot;values&quot;. The second field is an iterable of type <code>Row</code> containing all of the objects in the unique group from the first field.</p><p>This is most useful when you can perform aggregate calculations on this grouping and name the resulting fields, like so:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(purchases | GroupBy(&#x27;user_id&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             .aggregate_field(&quot;item_id&quot;, CountCombineFn(), &quot;num_purchases&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             .aggregate_field(&quot;cost_cents&quot;, sum, &quot;total_spend_cents&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             .aggregate_field(&quot;cost_cents&quot;, max, &quot;largest_purchases&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             .with_output_types(UserPurchases)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This returns a <code>Row</code> with fields corresponding to the &quot;key(s)&quot; we grouped by and the corresponding aggregations computed here.</p><p>The <code>aggregate_field</code> method takes three arguments. The first argument is a string, referring to the name of the field we wish to aggregate in the input PCollection&#x27;s schema. The second is the combiner we wish to apply, implemented as a subclass of <a href="https://beam.apache.org/releases/pydoc/2.28.0/apache_beam.transforms.core.html#apache_beam.transforms.core.CombineFn" target="_blank" rel="noopener noreferrer">CombineFn</a>. The third argument is a string that we use to identify the aggregation in the schema of the output PCollection.</p><p>Certain aggregation functions, such as <code>sum</code> and <code>max</code>, are implemented directly as combiners in Beam Python <a href="https://beam.apache.org/releases/pydoc/2.28.0/apache_beam.transforms.core.html#apache_beam.transforms.core.CombinePerKey" target="_blank" rel="noopener noreferrer">(Link)</a>. Count is implemented via <a href="https://beam.apache.org/releases/pydoc/2.28.0/apache_beam.transforms.combiners.html#apache_beam.transforms.combiners.Count" target="_blank" rel="noopener noreferrer">CountCombineFn</a>.</p><p>The output PCollection by default is a PCollection of type <code>Row</code>, but we can also apply our own custom types with schema using <code>with_output_types</code>. We see that above with <code>UserPurchases</code>. However, this means that we need to define a schema for type <code>UserPurchases</code>. We can do so easily by creating a subclass of <code>typing.NamedTuple</code> or via creating the schema ad hoc using <code>beam.Row</code> or <code>beam.Select</code>. We will cover the first case here. For the second please refer to the <a href="https://beam.apache.org/documentation/programming-guide/#schema-definition" target="_blank" rel="noopener noreferrer">Beam programming guide</a>.</p><p>The output of our aggregation above has four fields: <code>user_id</code> (type <code>str</code>), <code>num_purchases</code>, <code>total_spend_cents</code>, and <code>largest_purchases</code> (all type <code>int</code>).</p><p>We create a subclass of <code>NamedTuple</code> with these field names and types then register the coder for the schema:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class UserPurchases(typing.NamedTuple):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user_id : str</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  num_purchases : int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  total_spend_cents : int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  largest_purchases : int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">beam.coders.registry.register_coder(UserPurchases, beam.coders.RowCoder)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note: In this example you could aggregate on any of the fields for <code>CountCombineFn()</code>, or even on the wildcard field <code>*</code>, as this transform is simply counting how many elements are in the entire group.</p><p>The next step in the pipeline is to aggregate events by user_id, sum the pageviews, and also calculate some additional aggregations on num_bytes, for example total user bytes, maximum user bytes, and minimum user bytes.</p><p>To complete this task, add another transform to the pipeline that groups the events by <code>user_id</code> and then performs the relevant aggregations. Keep in mind the input, the CombineFns to use, and how you name the output fields. After this, create a new output type with schema (call it <code>PerUserAggregation</code>) and ensure that the output <code>Row</code> is converted into this type.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-3-run-your-pipeline">Task 3. Run your pipeline<a class="hash-link" href="#task-3-run-your-pipeline" title="Direct link to heading">​</a></h3><p>Return to Cloud Shell and execute the following command to run your pipeline using the Cloud Dataflow service. You can run it with DirectRunner if you&#x27;re having trouble, or refer to the <a href="https://github.com/GoogleCloudPlatform/training-data-analyst/tree/master/quests/dataflow_python/3_Batch_Analytics/solution/batch_user_traffic_pipeline.py" target="_blank" rel="noopener noreferrer">solution</a>.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export PROJECT_ID=$(gcloud config get-value project)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export REGION=Region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export BUCKET=gs://${PROJECT_ID}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export PIPELINE_FOLDER=${BUCKET}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export RUNNER=DataflowRunner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export INPUT_PATH=${PIPELINE_FOLDER}/events.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export TABLE_NAME=${PROJECT_ID}:logs.user_traffic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd $BASE_DIR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 batch_user_traffic_pipeline.py\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--project=${PROJECT_ID}\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--region=${REGION}\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--staging_location=${PIPELINE_FOLDER}/staging\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--temp_location=${PIPELINE_FOLDER}/temp\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--runner=${RUNNER}\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--input_path=${INPUT_PATH}\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--table_name=${TABLE_NAME}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-4-verify-results-in-bigquery">Task 4. Verify results in BigQuery<a class="hash-link" href="#task-4-verify-results-in-bigquery" title="Direct link to heading">​</a></h3><p>To complete this task, wait a few minutes for the pipeline to complete, then navigate to <a href="https://console.cloud.google.com/bigquery" target="_blank" rel="noopener noreferrer">BigQuery</a> and query the <code>user_traffic</code> table.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aggregating-site-traffic-by-minute">Aggregating site traffic by minute<a class="hash-link" href="#aggregating-site-traffic-by-minute" title="Direct link to heading">​</a></h2><p>In this part of the lab, you create a new pipeline called <code>batch_minute_traffic</code>. <code>batch_minute_traffic</code> expands on the basic batch analysis principles used in <code>batch_user_traffic</code> and, instead of aggregating by users across the entire batch, aggregates by when events occurred.</p><p>In the IDE, open the file <code>batch_minute_traffic_pipeline</code> inside <code>3_Batch_Analytics/lab</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-5-add-timestamps-to-each-element">Task 5. Add timestamps to each element<a class="hash-link" href="#task-5-add-timestamps-to-each-element" title="Direct link to heading">​</a></h3><p>An unbounded source provides a timestamp for each element. Depending on your unbounded source, you may need to configure how the timestamp is extracted from the raw data stream.</p><p>However, bounded sources (such as a file from TextIO, as is used in this pipeline) do not provide timestamps.</p><p>You can parse the timestamp field from each record and use the <a href="https://beam.apache.org/releases/pydoc/2.28.0/apache_beam.transforms.window.html#apache_beam.transforms.window.TimestampedValue" target="_blank" rel="noopener noreferrer">beam.window.TimestampedValue</a> transform to attach the timestamps to each element in your PCollection.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add_timestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">element</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ts </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Do Something</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> beam</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TimestampedValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">element</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ts</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unstamped </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stamped </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> unstamped </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> beam</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">add_timestamp</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To complete this task, add a transform to the pipeline that adds timestamps to each element of the pipeline. To do this, leverage the <a href="https://docs.python.org/3/library/datetime.html" target="_blank" rel="noopener noreferrer"><code>datetime</code></a> package to convert the timestamp field of the element into a <code>datetime</code> object. You may need to explore the <a href="https://docs.python.org/3/library/datetime.html" target="_blank" rel="noopener noreferrer"><code>datetime.strptime</code></a> function to do so.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-6-window-into-one-minute-windows">Task 6. Window into one-minute windows<a class="hash-link" href="#task-6-window-into-one-minute-windows" title="Direct link to heading">​</a></h3><p>Windowing subdivides a <code>PCollection</code> according to the timestamps of its individual elements. Transforms that aggregate multiple elements, such as <code>GroupByKey</code> and Combine, work implicitly on a per-window basis --- they process each <code>PCollection</code> as a succession of multiple, finite windows, though the entire collection itself may be of unbounded size.</p><p>You can define different kinds of windows to divide the elements of your <code>PCollection</code>. Beam provides several windowing functions, including:</p><ul><li>Fixed-time windows</li><li>Sliding-time windows</li><li>Per-session windows</li><li>Single global window</li><li>Calendar-based windows (not supported by the Beam SDK for Python, as of when this lab was written)</li></ul><p>In this lab, you use fixed-time windows. A fixed-time window represents a non-overlapping time interval of consistent duration in the data stream. Consider windows with a five-minute duration: all of the elements in your unbounded <code>PCollection</code> with timestamp values from 0:00:00 up to (but not including) 0:05:00 belong to the first window, elements with timestamp values from 0:05:00 up to (but not including) 0:10:00 belong to the second window, and so on.</p><p><img loading="lazy" src="https://user-images.githubusercontent.com/62965911/214003375-5f8bcc72-b62c-42fa-a9f3-f5ab9eeee4f7.png" class="img_ev3q"></p><p>Implement a fixed-time window with a five-minute duration as follows:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">p = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p_windowed = p | beam.WindowInto(beam.window.FixedWindows(5*60))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To complete this task, add a transform to your pipeline that windows elements into fixed windows one minute long.</p><p>To learn more about other types of windowing, read the Apache Beam documentation <a href="https://beam.apache.org/documentation/programming-guide/#provided-windowing-functions" target="_blank" rel="noopener noreferrer">Section 8.2. Provided windowing functions</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-7-count-events-per-window">Task 7. Count events per window<a class="hash-link" href="#task-7-count-events-per-window" title="Direct link to heading">​</a></h3><p>Next, the pipeline needs to compute the number of events that occurred within each window. In the batch_user_traffic pipeline, a <code>sum</code> transform was used to sum per key. However, unlike in that pipeline, in this case the elements have been windowed and the desired computation needs to respect window boundaries.</p><p>Despite this new constraint, the Combine transform is still appropriate. That&#x27;s because Combine transforms automatically respect window boundaries.</p><p>Refer to the documentation for <a href="https://beam.apache.org/releases/pydoc/2.28.0/apache_beam.transforms.combiners.html#apache_beam.transforms.combiners.Count" target="_blank" rel="noopener noreferrer">Count</a> for how to add a new transform that counts the number of elements per window.</p><p>As of Beam 2.28, the best option to count elements of rows while windowing is to use <code>beam.CombineGlobally(CountCombineFn()).without_defaults()</code> (that is, without using full-on SQL, which we will cover more in the next lab). This transform will output a <code>PCollection</code> of type <code>int</code> which, you&#x27;ll notice, is no longer using Beam schemas.</p><p>To complete this task, add a transform that counts all the elements in each window. Remember to refer to the <a href="https://github.com/GoogleCloudPlatform/training-data-analyst/tree/master/quests/dataflow_python/3_Batch_Analytics/solution/batch_minute_traffic_pipeline.py" target="_blank" rel="noopener noreferrer">solution</a> if you get stuck.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-8-convert-back-to-a-row-and-add-timestamp">Task 8. Convert back to a row and add timestamp<a class="hash-link" href="#task-8-convert-back-to-a-row-and-add-timestamp" title="Direct link to heading">​</a></h3><p>In order to write to BigQuery, each element needs to be converted to a <code>dict</code> object with &quot;page_views&quot; as a field and additional field called &quot;timestamp&quot;. The idea is to use the boundary of each window as one field and the combined number of pageviews as the other.</p><p>One other issue, at this point, is that the Count transform is only providing elements of type <code>int</code> that no longer bear any sort of timestamp information.</p><p>In fact, however, they do, though not in so obvious a way. Apache Beam runners know by default how to supply the value for a number of additional parameters, including event timestamps, windows, and pipeline options; for a full list refer to the <a href="https://beam.apache.org/documentation/programming-guide/#other-dofn-parameters" target="_blank" rel="noopener noreferrer">Apache&#x27;s DoFn parameters documentation</a>.</p><p>To complete this task, write a ParDo function that accepts elements of type int, passes in the additional parameter to access window information, <code>beam.DoFn.WindowParam</code>, and emits dictionaries with the fields mentioned above. Note that the timestamp field in the BigQuery table schema is a STRING, so you will have to convert the timestamp to a string. The <code>datetime.strftime</code> function will be helpful here.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">GetTimestampFn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">beam</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DoFn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> element</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> window</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">beam</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DoFn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WindowParam</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        window_start </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">#Do something!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        output </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;page_views&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> element</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;timestamp&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> window_start</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">yield</span><span class="token plain"> output</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-9-run-the-pipeline">Task 9. Run the pipeline<a class="hash-link" href="#task-9-run-the-pipeline" title="Direct link to heading">​</a></h3><p>Once you&#x27;ve finished coding, run the pipeline using the command below. Keep in mind that, while testing your code, it will be much faster to change the RUNNER environment variable to DirectRunner, which will run the pipeline locally.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export PROJECT_ID=$(gcloud config get-value project)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export REGION=Region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export BUCKET=gs://${PROJECT_ID}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export PIPELINE_FOLDER=${BUCKET}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export RUNNER=DataflowRunner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export INPUT_PATH=${PIPELINE_FOLDER}/events.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export TABLE_NAME=${PROJECT_ID}:logs.minute_traffic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd $BASE_DIR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 batch_minute_traffic_pipeline.py\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--project=${PROJECT_ID}\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--region=${REGION}\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--staging_location=${PIPELINE_FOLDER}/staging\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--temp_location=${PIPELINE_FOLDER}/temp\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--runner=${RUNNER}\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--input_path=${INPUT_PATH}\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--table_name=${TABLE_NAME}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-10-verify-the-results">Task 10. Verify the results<a class="hash-link" href="#task-10-verify-the-results" title="Direct link to heading">​</a></h3><p>To complete this task, wait a few minutes for the pipeline to execute, then navigate to <a href="https://console.cloud.google.com/bigquery" target="_blank" rel="noopener noreferrer">BigQuery</a> and query the <code>minute_traffic</code> table.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2023-04-17T11:57:21.000Z">Apr 17, 2023</time></b> by <b>sparsh</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/processing/lab-gcp-dataflow-pipeline"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Lab: GCP Dataflow Pipeline - A Simple Dataflow Pipeline (Python)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/processing/lab-gcp-dataflow-side-inputs"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Lab: GCP Dataflow Size Inputs</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#preparation" class="table-of-contents__link toc-highlight">Preparation</a><ul><li><a href="#jupyter-notebook-based-development-environment-setup" class="table-of-contents__link toc-highlight">Jupyter notebook-based development environment setup</a></li><li><a href="#download-code-repository" class="table-of-contents__link toc-highlight">Download Code Repository</a></li></ul></li><li><a href="#aggregating-site-traffic-by-user" class="table-of-contents__link toc-highlight">Aggregating site traffic by user</a><ul><li><a href="#task-1-generate-synthetic-data" class="table-of-contents__link toc-highlight">Task 1. Generate synthetic data</a></li><li><a href="#task-2-sum-page-views-per-user" class="table-of-contents__link toc-highlight">Task 2. Sum page views per user</a></li><li><a href="#task-3-run-your-pipeline" class="table-of-contents__link toc-highlight">Task 3. Run your pipeline</a></li><li><a href="#task-4-verify-results-in-bigquery" class="table-of-contents__link toc-highlight">Task 4. Verify results in BigQuery</a></li></ul></li><li><a href="#aggregating-site-traffic-by-minute" class="table-of-contents__link toc-highlight">Aggregating site traffic by minute</a><ul><li><a href="#task-5-add-timestamps-to-each-element" class="table-of-contents__link toc-highlight">Task 5. Add timestamps to each element</a></li><li><a href="#task-6-window-into-one-minute-windows" class="table-of-contents__link toc-highlight">Task 6. Window into one-minute windows</a></li><li><a href="#task-7-count-events-per-window" class="table-of-contents__link toc-highlight">Task 7. Count events per window</a></li><li><a href="#task-8-convert-back-to-a-row-and-add-timestamp" class="table-of-contents__link toc-highlight">Task 8. Convert back to a row and add timestamp</a></li><li><a href="#task-9-run-the-pipeline" class="table-of-contents__link toc-highlight">Task 9. Run the pipeline</a></li><li><a href="#task-10-verify-the-results" class="table-of-contents__link toc-highlight">Task 10. Verify the results</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Bootcamp. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.40c54d56.js"></script>
<script src="/assets/js/main.dbd2f5fe.js"></script>
</body>
</html>